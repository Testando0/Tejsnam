<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Telegram 2026 Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --tg-red: #FF3B30;
            --tg-bg: #000000;
            --tg-sec: #1C1C1E;
            --tg-bubble-me: #3E1010;
            --tg-bubble-them: #2C2C2E;
            --tg-text: #FFFFFF;
            --tg-gray: #8E8E93;
        }
        body, html { height: 100%; width: 100%; overflow: hidden; background: var(--tg-bg); color: var(--tg-text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .bg-blur { backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); }
        
        #chat-room { position: fixed; inset: 0; background: #000; z-index: 100; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
        .chat-open { transform: translateX(0) !important; }
        
        .msg-bubble { max-width: 80%; padding: 10px 14px; border-radius: 20px; font-size: 16px; line-height: 1.4; position: relative; }
        .msg-me { background: var(--tg-bubble-me); align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-them { background: var(--tg-bubble-them); align-self: flex-start; border-bottom-left-radius: 4px; }
        
        .status-ring { padding: 2px; border-radius: 50%; background: linear-gradient(45deg, #FF3B30, #FF9500); }
        .status-ring-viewed { background: #444; }
        
        #story-viewer { position: fixed; inset: 0; z-index: 600; background: #000; display: none; flex-direction: column; }
        #call-overlay { position: fixed; inset: 0; z-index: 500; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        
        input, textarea { background: transparent; outline: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <!-- Auth -->
    <div id="login-screen" class="fixed inset-0 flex flex-col items-center justify-center p-8 z-[1000] bg-black">
        <div class="w-24 h-24 bg-[#FF3B30] rounded-[2rem] flex items-center justify-center mb-8 shadow-2xl shadow-red-500/40">
            <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <h1 class="text-4xl font-black mb-2 italic uppercase">TELEGRAM <span class="text-[#FF3B30]">2026</span></h1>
        <p class="text-gray-500 mb-10 font-medium">Experiência Ultra Premium</p>
        <div class="w-full max-w-xs space-y-4">
            <input id="u_auth" placeholder="@username" class="w-full bg-[#1C1C1E] p-4 rounded-2xl text-white border border-white/5 focus:border-[#FF3B30]/50 transition-all">
            <input id="d_auth" placeholder="Nome de Exibição" class="hidden w-full bg-[#1C1C1E] p-4 rounded-2xl text-white border border-white/5 focus:border-[#FF3B30]/50 transition-all">
            <input id="p_auth" type="password" placeholder="Senha" class="w-full bg-[#1C1C1E] p-4 rounded-2xl text-white border border-white/5 focus:border-[#FF3B30]/50 transition-all">
            <button onclick="authAction()" id="btn-auth" class="w-full bg-[#FF3B30] text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-all">Entrar</button>
            <button onclick="toggleAuth()" id="btn-toggle" class="w-full text-gray-400 font-medium py-2">Criar conta premium</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden flex flex-col h-full">
        <header class="safe-pt bg-[#161616]/80 bg-blur border-b border-white/5 flex items-center justify-between px-5 py-3 shrink-0">
            <button class="text-[#FF3B30] font-semibold text-lg">Editar</button>
            <h1 class="font-bold text-xl">Conversas</h1>
            <button onclick="document.getElementById('new-chat-modal').classList.remove('hidden')" class="text-[#FF3B30]">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 4v16m8-8H4"/></svg>
            </button>
        </header>

        <div class="flex-1 overflow-y-auto no-scrollbar">
            <!-- Status -->
            <div class="flex gap-4 p-5 overflow-x-auto no-scrollbar border-b border-white/5">
                <div class="flex flex-col items-center gap-2 shrink-0 cursor-pointer" onclick="document.getElementById('status_file').click()">
                    <div class="relative w-16 h-16">
                        <img id="my_status_avatar" class="w-full h-full rounded-full object-cover border-2 border-dashed border-gray-700 p-0.5">
                        <div class="absolute bottom-0 right-0 bg-[#FF3B30] rounded-full p-1 border-2 border-black">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M12 4v16m8-8H4"/></svg>
                        </div>
                    </div>
                    <span class="text-[11px] font-bold text-gray-500">Meu Status</span>
                </div>
                <div id="status-list" class="flex gap-4"></div>
            </div>
            <!-- Chats -->
            <div id="tab-chats" class="divide-y divide-white/5"></div>
            <!-- Settings -->
            <div id="tab-settings" class="hidden p-6 space-y-8">
                <div class="flex flex-col items-center gap-4">
                    <div class="relative w-32 h-32 cursor-pointer group" onclick="document.getElementById('avatar_file').click()">
                        <img id="set_avatar" class="w-full h-full rounded-full object-cover border-4 border-white/5 shadow-2xl">
                        <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg></div>
                    </div>
                    <div class="text-center">
                        <h2 id="set_dn" class="text-3xl font-black"></h2>
                        <p id="set_un" class="text-[#FF3B30] font-bold text-lg"></p>
                    </div>
                </div>
                <div class="bg-[#1C1C1E] rounded-3xl overflow-hidden divide-y divide-white/5">
                    <div class="p-5"><label class="text-[10px] text-[#FF3B30] font-black uppercase">Bio</label><input id="set_bio" class="w-full mt-1 text-white font-medium" onblur="saveProfile()"></div>
                    <div class="p-5"><label class="text-[10px] text-[#FF3B30] font-black uppercase">Nome</label><input id="set_dn_input" class="w-full mt-1 text-white font-medium" onblur="saveProfile()"></div>
                    <div class="p-5 flex justify-between items-center cursor-pointer active:bg-white/5" onclick="document.getElementById('bg_file').click()"><span class="font-bold">Plano de Fundo</span><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg></div>
                </div>
                <button onclick="logout()" class="w-full bg-[#1C1C1E] py-5 rounded-3xl text-[#FF3B30] font-black text-xl active:scale-95 transition-all">SAIR DA CONTA</button>
            </div>
        </div>

        <nav class="safe-pb bg-[#161616]/90 bg-blur border-t border-white/5 flex justify-around pt-3 shrink-0">
            <button onclick="switchTab('chats')" id="btn-chats" class="active-tab flex flex-col items-center gap-1 w-20 text-gray-600"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg><span class="text-[10px] font-black uppercase">Chats</span></button>
            <button onclick="switchTab('settings')" id="btn-settings" class="flex flex-col items-center gap-1 w-20 text-gray-600"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span class="text-[10px] font-black uppercase">Ajustes</span></button>
        </nav>
    </div>

    <!-- Chat Room -->
    <div id="chat-room">
        <header class="safe-pt bg-[#161616]/95 bg-blur border-b border-white/5 flex items-center px-2 py-2 shrink-0">
            <button onclick="closeChat()" class="p-2 text-[#FF3B30]"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7"/></svg></button>
            <div class="flex-1 flex items-center gap-3 cursor-pointer overflow-hidden" onclick="showProfile()">
                <img id="chat_avatar" class="w-11 h-11 rounded-full object-cover border border-white/10">
                <div class="flex flex-col truncate">
                    <h3 id="chat_name" class="font-black text-lg truncate"></h3>
                    <span id="chat_status" class="text-xs font-bold text-gray-500 truncate"></span>
                </div>
            </div>
            <button onclick="startCall()" class="p-3 text-[#FF3B30] active:scale-90 transition-all"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg></button>
        </header>
        <div id="msg-container" class="flex-1 overflow-y-auto p-5 flex flex-col gap-2 bg-fixed bg-center bg-cover no-scrollbar"></div>
        <div class="safe-pb bg-[#161616]/95 bg-blur border-t border-white/5 px-4 py-3 flex items-end gap-3 shrink-0">
            <button onclick="document.getElementById('media_input').click()" class="p-2 text-gray-500 hover:text-[#FF3B30]"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 4v16m8-8H4"/></svg></button>
            <div class="flex-1 bg-[#1C1C1E] rounded-3xl border border-white/5 px-4 py-2 mb-1 flex items-center">
                <textarea id="chat-input" class="w-full text-white text-[16px] max-h-32 resize-none" placeholder="Mensagem..." rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
            </div>
            <button id="record-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()" class="bg-gray-800 text-white p-3 rounded-full mb-1 active:bg-[#FF3B30] transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
            </button>
            <button onclick="sendMsg()" class="bg-[#FF3B30] text-white p-3 rounded-full mb-1 shadow-xl active:scale-90 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
        </div>
    </div>

    <!-- Modais -->
    <div id="user-profile-modal" class="fixed inset-0 z-[400] hidden bg-black flex flex-col">
        <header class="safe-pt h-16 flex items-center px-5"><button onclick="document.getElementById('user-profile-modal').classList.add('hidden')" class="text-white"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7"/></svg></button></header>
        <div class="flex-1 overflow-y-auto flex flex-col items-center p-10">
            <img id="p_avatar" class="w-48 h-48 rounded-full object-cover border-8 border-[#1C1C1E] shadow-2xl">
            <h2 id="p_dn" class="text-4xl font-black mt-8"></h2>
            <p id="p_un" class="text-[#FF3B30] text-xl font-bold mt-2"></p>
            <div class="w-full bg-[#1C1C1E] mt-10 rounded-[2.5rem] p-8">
                <label class="text-xs text-gray-500 font-black uppercase">Bio</label>
                <p id="p_bio" class="text-white text-xl mt-2"></p>
            </div>
        </div>
    </div>

    <div id="story-viewer" onclick="nextStory()">
        <div class="absolute top-0 inset-x-0 h-1 flex gap-1 p-3 safe-pt z-[100]" id="story-bars"></div>
        <div class="absolute top-14 left-5 flex items-center gap-3 z-[100]">
            <img id="sv-avatar" class="w-12 h-12 rounded-full border-2 border-white/20">
            <div><h3 id="sv-name" class="font-black text-white"></h3><span id="sv-time" class="text-xs text-white/60"></span></div>
        </div>
        <div class="flex-1 flex items-center justify-center bg-black"><img id="sv-img" class="max-w-full max-h-full object-contain shadow-2xl"></div>
        <div class="absolute bottom-12 inset-x-0 p-8 text-center z-[100]"><p id="sv-caption" class="text-white text-xl font-medium bg-black/60 inline-block px-6 py-3 rounded-2xl backdrop-blur"></p></div>
        <div id="sv-viewers-btn" class="absolute bottom-4 inset-x-0 flex flex-col items-center z-[100] cursor-pointer hidden" onclick="event.stopPropagation();showViewers()">
            <svg class="w-6 h-6 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            <span id="sv-count" class="text-[10px] text-white/60 font-bold">0</span>
        </div>
    </div>

    <div id="call-overlay">
        <img id="call-avatar" class="w-40 h-40 rounded-full border-4 border-[#FF3B30] mb-8 shadow-2xl">
        <h2 id="call-name" class="text-4xl font-black mb-2"></h2>
        <p id="call-status" class="text-[#FF3B30] font-black text-xl animate-pulse uppercase tracking-widest">Chamando...</p>
        <div class="flex gap-8 mt-10">
            <button onclick="toggleMute()" id="mute-btn" class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center text-white active:bg-white/20"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path id="mute-icon" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg></button>
            <button onclick="toggleSpeaker()" id="speaker-btn" class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center text-white active:bg-white/20"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg></button>
        </div>
        <div class="absolute bottom-24 flex gap-16">
            <button onclick="endCall()" class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition-all"><svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79a15.15 15.15 0 006.59 6.59l2.2-2.2a1 1 0 011.11-.27c1.12.45 2.33.69 3.58.69a1 1 0 011 1V20a1 1 0 01-1 1c-9.39 0-17-7.61-17-17a1 1 0 011-1h3.5a1 1 0 011 1c0 1.25.24 2.46.69 3.58a1 1 0 01-.27 1.11l-2.2 2.2z"/></svg></button>
            <button id="btn-accept" onclick="acceptCall()" class="hidden w-20 h-20 bg-green-600 rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition-all"><svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20 15.5c-1.2 0-2.4-.2-3.6-.6-.3-.1-.7 0-1 .2l-2.2 2.2c-2.8-1.4-5.1-3.8-6.6-6.6l2.2-2.2c.3-.3.4-.7.2-1-.3-1.1-.5-2.3-.5-3.5 0-.6-.4-1-1-1H4c-.6 0-1 .4-1 1 0 9.4 7.6 17 17 17 .6 0 1-.4 1-1v-3.5c0-.6-.4-1-1-1z"/></svg></button>
        </div>
    </div>

    <div id="new-chat-modal" class="fixed inset-0 z-[1000] hidden bg-black/90 backdrop-blur flex items-center justify-center p-6">
        <div class="w-full max-w-sm bg-[#1C1C1E] rounded-[2.5rem] p-8 border border-white/5">
            <h3 class="text-2xl font-black mb-6">Nova Conversa</h3>
            <input id="new-chat-input" placeholder="@username" class="w-full bg-black p-5 rounded-2xl text-white border border-white/10 mb-6">
            <div class="flex gap-4">
                <button onclick="document.getElementById('new-chat-modal').classList.add('hidden')" class="flex-1 py-4 text-gray-500 font-bold">Cancelar</button>
                <button onclick="startChat()" class="flex-1 py-4 bg-[#FF3B30] text-white font-black rounded-2xl shadow-xl">Iniciar</button>
            </div>
        </div>
    </div>

    <input type="file" id="avatar_file" hidden accept="image/*" onchange="upload('avatar', event)">
    <input type="file" id="bg_file" hidden accept="image/*" onchange="upload('bg', event)">
    <input type="file" id="status_file" hidden accept="image/*" onchange="upload('status', event)">
    <input type="file" id="media_input" hidden accept="image/*,video/*" onchange="sendMedia(event)">

    <script>
        const socket = io();
        let me = null, active = null, pc = null, stream = null, call = null, statuses = [], stIdx = 0, isReg = false;
        let recorder = null, audioChunks = [], isMuted = false, isSpeaker = false;
        const ice = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        function toggleAuth() {
            isReg = !isReg;
            document.getElementById('d_auth').classList.toggle('hidden', !isReg);
            document.getElementById('btn-auth').innerText = isReg ? 'Cadastrar' : 'Entrar';
            document.getElementById('btn-toggle').innerText = isReg ? 'Já tenho conta premium' : 'Criar conta premium';
        }

        async function authAction() {
            const u = document.getElementById('u_auth').value.trim().replace('@','').toLowerCase();
            const p = document.getElementById('p_auth').value.trim();
            const dn = document.getElementById('d_auth').value.trim();
            if(!u || !p) return;
            const res = await fetch(isReg ? '/register' : '/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p, display_name:dn}) });
            const data = await res.json();
            if(data.ok || (!data.error && !isReg)) {
                if(!isReg) { me = data; localStorage.setItem('tg_v2026', JSON.stringify(me)); enter(); }
                else { alert("Conta Premium Criada!"); toggleAuth(); }
            } else alert(data.error);
        }

        window.onload = () => { const s = localStorage.getItem('tg_v2026'); if(s) { me = JSON.parse(s); enter(); } };

        function enter() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            socket.emit('join', me.username);
            updateUI(); loadChats(); loadStatus();
        }

        function logout() { localStorage.removeItem('tg_v2026'); location.reload(); }

        async function loadChats() {
            const d = await fetch('/chats/'+me.username).then(r=>r.json());
            document.getElementById('tab-chats').innerHTML = d.map(c => `
                <div onclick="openChat('${c.contact}')" class="flex items-center gap-4 p-5 active:bg-white/5 transition-all cursor-pointer">
                    <div class="relative w-16 h-16 shrink-0">
                        <img src="${c.avatar || 'https://ui-avatars.com/api/?background=1C1C1E&color=fff&name='+c.display_name}" class="w-full h-full rounded-full object-cover">
                        ${c.is_online ? '<div class="absolute bottom-0.5 right-0.5 w-4 h-4 bg-green-500 rounded-full border-[3px] border-black"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline"><h3 class="font-black text-lg text-white truncate">${c.display_name}</h3><span class="text-xs font-bold text-gray-500">${formatTime(c.last_time)}</span></div>
                        <div class="flex justify-between items-center mt-1"><p class="text-[15px] text-gray-500 truncate font-medium">${c.type==='text'?c.last_msg:'[Mídia]'}</p>${c.unread ? `<span class="bg-[#FF3B30] text-white text-[10px] font-black px-2 py-0.5 rounded-full">${c.unread}</span>` : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        async function openChat(u) {
            active = u; const ud = await fetch('/user/'+u).then(r=>r.json());
            document.getElementById('chat_name').innerText = ud.display_name;
            document.getElementById('chat_avatar').src = ud.avatar || `https://ui-avatars.com/api/?background=1C1C1E&color=fff&name=${ud.display_name}`;
            document.getElementById('chat_status').innerText = ud.is_online ? 'Online' : 'Visto ' + formatSeen(ud.last_seen);
            document.getElementById('chat_status').className = ud.is_online ? 'text-xs font-black text-[#FF3B30]' : 'text-xs font-bold text-gray-500';
            document.getElementById('msg-container').style.backgroundImage = me.bg_image ? `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url(${me.bg_image})` : 'none';
            document.getElementById('chat-room').classList.add('chat-open');
            const msgs = await fetch(`/messages/${me.username}/${active}`).then(r=>r.json());
            const cont = document.getElementById('msg-container'); cont.innerHTML = ''; msgs.forEach(addMsg); cont.scrollTop = cont.scrollHeight;
            socket.emit('mark_read', { s: u, r: me.username });
        }

        function addMsg(m) {
            const isMe = m.s === me.username;
            const div = document.createElement('div'); div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
            let content = `<p>${m.c}</p>`;
            if(m.type === 'image') content = `<img src="${m.c}" class="rounded-xl max-w-full shadow-lg border border-white/5"><p class="mt-2 text-sm">${m.caption||''}</p>`;
            if(m.type === 'video') content = `<video src="${m.c}" controls class="rounded-xl max-w-full shadow-lg border border-white/5"></video><p class="mt-2 text-sm">${m.caption||''}</p>`;
            if(m.type === 'audio') content = `<audio src="${m.c}" controls class="w-full"></audio>`;
            div.innerHTML = `<div class="msg-bubble ${isMe ? 'msg-me' : 'msg-them'}">${content}<div class="flex items-center justify-end gap-1 mt-1 opacity-50 text-[9px] font-black"><span>${formatTime(m.time)}</span>${isMe ? `<span>${m.status === 2 ? '✓✓' : '✓'}</span>` : ''}</div></div>`;
            document.getElementById('msg-container').appendChild(div);
        }

        function sendMsg() {
            const i = document.getElementById('chat-input'); const t = i.value.trim(); if(!t) return;
            const d = { s:me.username, r:active, c:t, type:'text' };
            socket.emit('send_msg', d); addMsg({...d, time: new Date().toISOString(), status: 1});
            i.value = ''; i.style.height = 'auto'; document.getElementById('msg-container').scrollTop = 999999;
        }

        async function startRecording() {
            if (!navigator.mediaDevices) return;
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            audioChunks = [];
            recorder.ondataavailable = e => audioChunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onload = () => {
                    const d = { s:me.username, r:active, c:reader.result, type:'audio' };
                    socket.emit('send_msg', d);
                };
                reader.readAsDataURL(blob);
                stream.getTracks().forEach(t => t.stop());
            };
            recorder.start();
            document.getElementById('record-btn').classList.add('recording-pulse');
        }

        function stopRecording() {
            if (recorder && recorder.state === 'recording') {
                recorder.stop();
                document.getElementById('record-btn').classList.remove('recording-pulse');
            }
        }

        async function sendMedia(e) {
            const f = e.target.files[0]; if(!f) return;
            const type = f.type.split('/')[0];
            const reader = new FileReader();
            reader.onload = () => {
                const cap = prompt("Legenda (opcional):") || '';
                const d = { s:me.username, r:active, c:reader.result, type, caption: cap };
                socket.emit('send_msg', d);
            };
            reader.readAsDataURL(f);
        }

        async function upload(type, e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = async () => {
                if(type === 'status') {
                    const cap = prompt("Legenda do Status:") || '';
                    await fetch('/post-status', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:me.username, content:r.result, type:'image', caption:cap}) });
                } else {
                    const body = { username: me.username };
                    if(type === 'avatar') body.avatar = r.result; else body.bg_image = r.result;
                    await fetch('/update-profile', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
                }
            };
            r.readAsDataURL(f);
        }

        async function loadStatus() {
            const d = await fetch('/get-status').then(r=>r.json()); statuses = d;
            document.getElementById('my_status_avatar').src = me.avatar || `https://ui-avatars.com/api/?background=1C1C1E&color=fff&name=${me.display_name}`;
            const list = document.getElementById('status-list'); list.innerHTML = '';
            const groups = {}; d.forEach(s => { if(!groups[s.username]) groups[s.username] = s; });
            Object.values(groups).forEach((s, idx) => {
                const viewed = s.viewers.includes(me.username);
                const div = document.createElement('div'); div.className = 'flex flex-col items-center gap-2 shrink-0 cursor-pointer';
                div.onclick = () => openStatus(idx);
                div.innerHTML = `<div class="status-ring ${viewed?'status-ring-viewed':''}"><img src="${s.avatar || 'https://ui-avatars.com/api/?background=1C1C1E&color=fff&name='+s.display_name}" class="w-14 h-14 rounded-full object-cover border-2 border-black"></div><span class="text-[11px] font-bold text-gray-500 truncate w-16 text-center">${s.display_name}</span>`;
                list.appendChild(div);
            });
        }

        function openStatus(idx) {
            stIdx = idx; const s = statuses[idx];
            document.getElementById('story-viewer').style.display = 'flex';
            document.getElementById('sv-img').src = s.content;
            document.getElementById('sv-name').innerText = s.display_name;
            document.getElementById('sv-avatar').src = s.avatar || `https://ui-avatars.com/api/?background=1C1C1E&color=fff&name=${s.display_name}`;
            document.getElementById('sv-time').innerText = formatSeen(s.time);
            document.getElementById('sv-caption').innerText = s.caption || '';
            document.getElementById('sv-count').innerText = s.viewers.length;
            
            const vBtn = document.getElementById('sv-viewers-btn');
            if(s.username === me.username) vBtn.classList.remove('hidden');
            else vBtn.classList.add('hidden');

            socket.emit('view_status', { story_id: s.id, viewer: me.username, owner: s.username });
        }
        function nextStory() { stIdx++; if(stIdx >= statuses.length) document.getElementById('story-viewer').style.display = 'none'; else openStatus(stIdx); }

        function showViewers() {
            const s = statuses[stIdx];
            if(s.username !== me.username) return;
            alert("Visualizado por:\n" + (s.viewers.join('\n') || "Ninguém ainda"));
        }

        async function showProfile() {
            const u = await fetch('/user/'+active).then(r=>r.json());
            document.getElementById('p_avatar').src = u.avatar || `https://ui-avatars.com/api/?background=1C1C1E&color=fff&name=${u.display_name}`;
            document.getElementById('p_dn').innerText = u.display_name;
            document.getElementById('p_un').innerText = '@' + u.username;
            document.getElementById('p_bio').innerText = u.bio || 'Sem bio.';
            document.getElementById('user-profile-modal').classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('set_avatar').src = me.avatar || `https://ui-avatars.com/api/?background=1C1C1E&color=fff&name=${me.display_name}`;
            document.getElementById('set_dn').innerText = me.display_name;
            document.getElementById('set_un').innerText = '@' + me.username;
            document.getElementById('set_bio').value = me.bio || '';
            document.getElementById('set_dn_input').value = me.display_name;
        }

        async function saveProfile() {
            const dn = document.getElementById('set_dn_input').value, bio = document.getElementById('set_bio').value;
            await fetch('/update-profile', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username: me.username, display_name: dn, bio: bio}) });
        }

        function toggleMute() {
            isMuted = !isMuted;
            if(stream) stream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('mute-btn').classList.toggle('bg-red-500', isMuted);
            document.getElementById('mute-icon').setAttribute('d', isMuted ? 'M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z M2 2l20 20' : 'M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z');
        }

        function toggleSpeaker() {
            isSpeaker = !isSpeaker;
            const audios = document.querySelectorAll('audio');
            audios.forEach(a => { if(a.sinkId) a.setSinkId(isSpeaker ? 'default' : ''); });
            document.getElementById('speaker-btn').classList.toggle('bg-blue-500', isSpeaker);
        }

        function formatTime(t) { if(!t) return ''; return new Date(t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        function formatSeen(t) { if(!t) return 'há algum tempo'; const diff = (new Date() - new Date(t)) / 1000; if(diff < 60) return 'agora'; if(diff < 3600) return Math.floor(diff/60)+'m atrás'; return formatTime(t); }
        function switchTab(t) {
            ['chats','settings'].forEach(x => { document.getElementById('tab-'+x).classList.add('hidden'); document.getElementById('btn-'+x).classList.remove('active-tab'); });
            document.getElementById('tab-'+t).classList.remove('hidden'); document.getElementById('btn-'+t).classList.add('active-tab');
            if(t==='chats') loadChats();
        }
        function closeChat() { document.getElementById('chat-room').classList.remove('chat-open'); active = null; loadChats(); }
        function startChat() { const u = document.getElementById('new-chat-input').value.trim().replace('@','').toLowerCase(); if(u) { document.getElementById('new-chat-modal').classList.add('hidden'); openChat(u); } }

        // Sockets
        socket.on('new_msg', m => { if(active===m.s) { addMsg(m); socket.emit('mark_read', { s: m.s, r: me.username }); } else { loadChats(); } });
        socket.on('msg_sent_ok', m => { if(active === m.r) { loadChats(); if(m.type !== 'text') addMsg(m); } });
        socket.on('msgs_read_update', d => { if(active===d.reader) { loadChats(); openChat(active); } });
        socket.on('user_status_change', () => { if(active) openChat(active); loadChats(); });
        socket.on('status_viewed_update', d => { if(statuses[stIdx] && statuses[stIdx].id === d.story_id) { statuses[stIdx].viewers = d.viewers; document.getElementById('sv-count').innerText = d.viewers.length; } loadStatus(); });
        socket.on('profile_updated', d => { if(d.username === me.username) { me = d.user; localStorage.setItem('tg_v2026', JSON.stringify(me)); updateUI(); } if(active === d.username) openChat(active); loadChats(); loadStatus(); });
        socket.on('new_story_posted', () => loadStatus());

        // Calls
        async function startCall() {
            const u = await fetch('/user/'+active).then(r=>r.json());
            document.getElementById('call-name').innerText = u.display_name;
            document.getElementById('call-avatar').src = u.avatar || `https://ui-avatars.com/api/?background=1C1C1E&color=fff&name=${u.display_name}`;
            document.getElementById('call-overlay').style.display = 'flex';
            call = { to: active };
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            pc = new RTCPeerConnection(ice);
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
            pc.onicecandidate = e => { if(e.candidate) socket.emit('ice_candidate', { to: active, from: me.username, candidate: e.candidate }); };
            const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            socket.emit('call_user', { to: active, from: me.username, offer });
        }
        socket.on('call_incoming', async d => {
            const u = await fetch('/user/'+d.from).then(r=>r.json());
            document.getElementById('call-name').innerText = u.display_name;
            document.getElementById('call-avatar').src = u.avatar || `https://ui-avatars.com/api/?background=1C1C1E&color=fff&name=${u.display_name}`;
            document.getElementById('call-status').innerText = 'Chamada recebida';
            document.getElementById('btn-accept').classList.remove('hidden');
            document.getElementById('call-overlay').style.display = 'flex';
            call = d;
        });
        async function acceptCall() {
            document.getElementById('call-status').innerText = 'Em chamada'; document.getElementById('btn-accept').classList.add('hidden');
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            pc = new RTCPeerConnection(ice);
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
            pc.onicecandidate = e => { if(e.candidate) socket.emit('ice_candidate', { to: call.from, from: me.username, candidate: e.candidate }); };
            pc.ontrack = e => { const a = new Audio(); a.srcObject = e.streams[0]; a.play(); };
            await pc.setRemoteDescription(new RTCSessionDescription(call.offer));
            const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
            socket.emit('answer_call', { to: call.from, from: me.username, answer: ans });
        }
        socket.on('call_answered', async d => { document.getElementById('call-status').innerText = 'Em chamada'; await pc.setRemoteDescription(new RTCSessionDescription(d.answer)); });
        socket.on('ice_candidate', async d => { if(pc) await pc.addIceCandidate(new RTCIceCandidate(d.candidate)); });
        socket.on('call_ended', stopCall);
        function endCall() { const to = call?.from || call?.to; if(to) socket.emit('end_call', {to, from: me.username}); stopCall(); }
        function stopCall() { if(pc) pc.close(); if(stream) stream.getTracks().forEach(t=>t.stop()); document.getElementById('call-overlay').style.display='none'; }
    </script>
</body>
</html>